---
// src/pages/index.astro
import { PostPreview } from 'astro-pure/components/pages'
import { getBlogCollection, sortMDByDate } from 'astro-pure/server'
import { Button } from 'astro-pure/user'
import { UButton } from '^/components/user/custom'
import PageLayout from '@/layouts/BaseLayout.astro' // Assumes header is part of this layout
import config from '@/site-config'

// --- Blog Post Fetching ---
const MAX_POSTS = 3
let allPostsByDate;
try {
  const allPosts = await getBlogCollection()
  allPostsByDate = sortMDByDate(allPosts).slice(0, MAX_POSTS)
} catch (error) {
  console.error('Error fetching blog posts:', error)
}

// --- Placeholder data - replace ---
const universityName = 'the University of Astro'
const aboutPageLink = '/about'
const projectsPageLink = '/projects'
const blogPageLink = '/blog'
---

{/* BaseLayout likely includes the <header-component> via its slot */}
<PageLayout meta={{ title: 'Home' }} highlightColor='#5e81ac'>
  {/* Hero Section - Takes full viewport height initially */}
  {/* Use flex to center content vertically & horizontally */}
  {
    /* `relative` is needed for potential absolute positioned elements inside like scroll indicator */
  }
  {/* `overflow-hidden` prevents text showing outside bounds during parallax */}
  <section
    class='hero-section relative flex flex-grow min-h-screen flex-col items-center justify-center overflow-hidden text-center'
  >
    {/* Text container for GSAP targeting */}
    <div class='text-container z-10' style='translate: 0 -12.5vh;'>
      {/* z-10 ensures text is above potential background elements */}
      {/* align these texts at the left side*/}
      <div class='flex flex-grow flex-col items-start'>
        <h1
          class='fade-in-up text-5xl font-light text-slate-900 opacity-0 dark:text-white md:text-5xl lg:text-5xl'
          style='animation-delay: 0.5s; font-weight: 200;'
        >
          Call me
        </h1>
        <h1
          class='fade-in-up mt-2 text-7xl font-medium text-slate-900 opacity-0 dark:text-white md:text-8xl lg:text-9xl'
          style='animation-delay: 1.5s; font-weight: 200; font-family: "Ubuntu";'
        >
          {config.author}
        </h1>
      </div>
    </div>
    {/* Optional: Scroll down indicator */}
    <div
      class='absolute bottom-10 z-10 animate-bounce opacity-0 fade-in-up'
      style='animation-delay: 2.5s;'
    >
      <svg
        class='mx-auto h-8 w-8 text-slate-500 dark:text-slate-400'
        fill='none'
        stroke='currentColor'
        viewBox='0 0 24 24'
        xmlns='http://www.w3.org/2000/svg'
        ><path
          stroke-linecap='round'
          stroke-linejoin='round'
          stroke-width='2'
          d='M19 14l-7 7m0 0l-7-7m7 7V3'></path></svg
      >
    </div>
  </section>

  {/* Parallax Content Sections Container */}
  {/* `relative z-0` ensures this content scrolls UNDER the sticky header (z-30) */}
  <div class='content-container relative z-0 overflow-x-hidden bg-white dark:bg-gray-900 dark:bg-opacity-20'>
    {/* 1. About Me Section */}
    <section id='about-section' class='parallax-section min-h-[60vh] md:py-32'>
      <div class='container mx-auto max-w-4xl px-6 text-center'>
        <h2 class='section-title mb-6 text-3xl font-semibold md:text-4xl '>About Me</h2>
        <p class='section-content mb-8 text-lg text-slate-700 dark:text-slate-300 md:text-xl'>
          A student at {universityName}, an enthusiastic full-stack developer exploring the web, and
          always eager to learn and create.
        </p>
        <UButton
          href={aboutPageLink}
          title='Learn More'
          size='lg'
          class='underlined-button astro-pure-button'
          style="animation-delay: 1s !important;"
          appendIcon="carbon:arrow-right"
        />
      </div>
    </section>

    {/* 2. Projects Section */}
    <section
      id='projects-section'
      class='parallax-section min-h-[80vh] bg-slate-50 py-20 dark:bg-gray-800 dark:bg-opacity-20 md:py-32'
    >
      <div class='container mx-auto max-w-6xl px-6'>
        <h2 class='section-title mb-12 text-center text-3xl font-semibold md:text-4xl'>Projects</h2>
        <div class='grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3'>
          {/* Placeholder Project Cards */}
          <div
            class='project-card rounded-lg border border-slate-200 bg-white p-6 shadow-md dark:border-slate-700 dark:bg-slate-900'
          >
            <div class='mb-4 h-40 rounded bg-slate-200 dark:bg-slate-700'></div>
            <h3 class='mb-2 text-xl font-medium'>Project One</h3>
            <p class='text-sm text-slate-600 dark:text-slate-400'>Brief description...</p>
          </div>
          <div
            class='project-card rounded-lg border border-slate-200 bg-white p-6 shadow-md dark:border-slate-700 dark:bg-slate-900'
            style='--card-delay: 0.1s;'
          >
            <div class='mb-4 h-40 rounded bg-slate-200 dark:bg-slate-700'></div>
            <h3 class='mb-2 text-xl font-medium'>Project Two</h3>
            <p class='text-sm text-slate-600 dark:text-slate-400'>Brief description...</p>
          </div>
          <div
            class='project-card rounded-lg border border-slate-200 bg-white p-6 shadow-md dark:border-slate-700 dark:bg-slate-900'
            style='--card-delay: 0.2s;'
          >
            <div class='mb-4 h-40 rounded bg-slate-200 dark:bg-slate-700'></div>
            <h3 class='mb-2 text-xl font-medium'>Project Three</h3>
            <p class='text-sm text-slate-600 dark:text-slate-400'>Brief description...</p>
          </div>
        </div>
        <div class='mt-12 text-center'>
          <UButton
            href={projectsPageLink}
            title='View all projects'
            size='lg'
            class='underlined-button astro-pure-button'
            style="animation-delay: 1s !important;"
            appendIcon="carbon:arrow-right"
          />
        </div>
      </div>
    </section>

    {/* 3. Hobbies Section */}
    <section id='hobbies-section' class='parallax-section min-h-[70vh] py-20 md:py-32'>
      <div class='container mx-auto max-w-4xl px-6'>
        <h2 class='section-title mb-12 text-center text-3xl font-semibold md:text-4xl'>
          Hobbies & Interests
        </h2>
        <ul class='space-y-8'>
          <li class='hobby-item flex items-start gap-4'>
            <span class='mt-1 text-2xl'>ðŸŽ¨</span>
            <div>
              <h3 class='mb-1 text-xl font-medium'>Amateur CG Artist</h3>
              <p class='text-slate-700 dark:text-slate-300'>
                Exploring 3D.
              </p>
            </div>
          </li>
          <li class='hobby-item flex items-start gap-4'>
            <span class='mt-1 text-2xl'>ðŸŽ®</span>
            <div>
              <h3 class='mb-1 text-xl font-medium'>Game Developer</h3>
              <p class='text-slate-700 dark:text-slate-300'>Crafting interactive experiences.</p>
            </div>
          </li>
          <li class='hobby-item flex items-start gap-4'>
            <span class='mt-1 text-2xl'>ðŸ§±</span>
            <div>
              <h3 class='mb-1 text-xl font-medium'>Minecraft Modder & Redstoner</h3>
              <p class='text-slate-700 dark:text-slate-300'>Pushing blocky boundaries.</p>
            </div>
          </li>
        </ul>
      </div>
    </section>

    {/* 4. Blog Preview Section */}
    {
      allPostsByDate && allPostsByDate.length > 0 && (
        <section
          id='blog-section'
          class='parallax-section min-h-[70vh] bg-slate-50 py-20 dark:bg-gray-900 dark:bg-opacity-20 md:py-32'
        >
          <div class='container mx-auto max-w-4xl px-6'>
            <h2 class='section-title mb-12 text-center text-3xl font-semibold md:text-4xl'>
              Latest Posts
            </h2>
            <div class='space-y-8'>
              {allPostsByDate.map((p) => (
                <div class='blog-post-item'>
                  {' '}
                  <PostPreview post={p} />{' '}
                </div>
              ))}
            </div>
            <div class='mt-12 text-center'>
              <UButton
                href={blogPageLink}
                title='Visit Blog'
                size='lg'
                class='underlined-button astro-pure-button'
                appendIcon='carbon:arrow-right'
              />
            </div>
          </div>
        </section>
      )
    }
  </div>
  {/* End content-container */}
</PageLayout>

{/* ----- STYLES ----- */}
<style is:global>
  /* Basic styles for hero text fade-in */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .fade-in-up {
    animation: fadeInUp 1s ease-out forwards;
  }

  /* Styles for GSAP - Content sections start hidden/offset */
  .parallax-section .section-title,
  .parallax-section .section-content,
  .parallax-section .project-card,
  .parallax-section .hobby-item,
  .parallax-section .blog-post-item,
  .parallax-section .astro-pure-button {
    opacity: 0;
    transform: translateY(40px);
  }

  /* Ensure last section has padding before potential footer */
  .content-container section:last-child {
    padding-bottom: 6rem;
  }

  @media (prefers-reduced-motion: reduce) {
    .fade-in-up {
      animation: none;
      opacity: 1;
    }
    /* GSAP elements should be visible if motion is reduced */
    .parallax-section .section-title,
    .parallax-section .section-content,
    .parallax-section .project-card,
    .parallax-section .hobby-item,
    .parallax-section .blog-post-item,
    .parallax-section .astro-pure-button {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

{/* ----- GSAP SCRIPT ----- */}
<script>
  import { gsap } from 'gsap'
  import { ScrollTrigger } from 'gsap/ScrollTrigger'

  gsap.registerPlugin(ScrollTrigger)

  document.addEventListener('DOMContentLoaded', () => {
    // --- Hero Text Parallax & Fade ---
    gsap.to('.hero-section .text-container', {
      yPercent: -50, // Move up 50% of its own height
      opacity: 0, // Fade out
      ease: 'none', // Linear progression tied to scroll
      scrollTrigger: {
        trigger: '.hero-section', // Element that triggers the animation
        start: 'top top', // Start when hero top hits viewport top
        end: 'bottom 60%', // End when hero bottom hits 60% from viewport top
        // Adjust '60%' to control fade duration/speed
        scrub: 1 // Smooth scrubbing (1 second catch-up time)
        // markers: true,         // Uncomment for debugging trigger points
      }
    })

    // --- Content Section Animations ---
    gsap.utils.toArray<Element>('.parallax-section').forEach((section) => {
      const title = section.querySelector('.section-title')
      const content = section.querySelectorAll(
        '.section-content, .hobby-item, .blog-post-item, .astro-pure-button'
      )
      const cards = section.querySelectorAll('.project-card')

      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: section,
          start: 'top 80%',
          end: 'bottom 20%',
          toggleActions: 'play none none reverse'
          // markers: true, // Uncomment for debugging
        },
        defaults: {
          // Set default ease and duration for this timeline
          ease: 'power2.out',
          duration: 0.8
        }
      })

      if (title) {
        tl.to(title, { opacity: 1, y: 0 })
      }
      if (content.length > 0) {
        tl.to(content, { opacity: 1, y: 0, stagger: 0.15 }, '-=0.5')
      }
      if (cards.length > 0) {
        tl.to(
          cards,
          { opacity: 1, y: 0, duration: 0.7, stagger: { amount: 0.4, from: 'start' } },
          '-=0.5'
        )
      }
    })

    // --- Optional: Content Title Parallax (Subtle scroll effect) ---
    gsap.utils.toArray<Element>('.parallax-section .section-title').forEach((title) => {
      gsap.to(title, {
        yPercent: -20, // Move title up slightly faster than scroll
        ease: 'none',
        scrollTrigger: {
          trigger: title.closest('.parallax-section'),
          start: 'top bottom', // Start when section enters viewport
          end: 'bottom top', // End when section leaves viewport
          scrub: 1.5 // Smooth scrubbing
        }
      })
    })

    // --- Reduced Motion Check ---
    // GSAP respects prefers-reduced-motion by default for basic tweens,
    // but ScrollTrigger animations might still run. Add this for safety.
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    if (prefersReducedMotion) {
      ScrollTrigger.getAll().forEach((st) => st.kill()) // Disable all ScrollTriggers
      gsap.set('.hero-section .text-container', { yPercent: 0, opacity: 1 }) // Ensure hero text is visible
      console.log('Reduced motion enabled, GSAP ScrollTriggers disabled.')
    } else {
      console.log('GSAP animations initialized.')
    }
  })
</script>
